<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
    <meta name="mobile-web-app-capable" content="yes">
    <title>Rapport de Chantier - Feldner R√©seaux</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif; background: linear-gradient(135deg, #e2e8f0 0%, #bfdbfe 100%); min-height: 100vh; padding: 16px; }
        .container { max-width: 1200px; margin: 0 auto; }
        .status-bar { background: #dcfce7; border: 2px solid #86efac; padding: 16px; border-radius: 12px; margin-bottom: 16px; display: flex; justify-content: space-between; align-items: center; }
        .status-bar.offline { background: #fed7aa; border-color: #fb923c; }
        .card { background: white; border-radius: 16px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); padding: 24px; margin-bottom: 16px; }
        .header { display: flex; justify-content: space-between; align-items: center; border-bottom: 4px solid #3b82f6; padding-bottom: 16px; margin-bottom: 24px; }
        h1 { font-size: 28px; font-weight: bold; }
        h2 { font-size: 22px; font-weight: bold; margin-bottom: 16px; }
        .section { padding: 24px; border-radius: 12px; margin-bottom: 24px; border: 2px solid; }
        .section-blue { background: #dbeafe; border-color: #93c5fd; }
        .section-green { background: #dcfce7; border-color: #86efac; }
        .section-orange { background: #fed7aa; border-color: #fdba74; }
        .section-red { background: #fecaca; border-color: #fca5a5; }
        .section-purple { background: #e9d5ff; border-color: #c084fc; }
        input, select, textarea { width: 100%; padding: 12px 16px; font-size: 16px; border: 2px solid #d1d5db; border-radius: 8px; margin-top: 8px; }
        input:focus, select:focus, textarea:focus { outline: none; border-color: #3b82f6; }
        label { display: block; font-weight: 600; font-size: 14px; margin-top: 12px; }
        button { padding: 12px 20px; font-size: 16px; font-weight: 600; border: none; border-radius: 8px; cursor: pointer; }
        .btn-primary { background: #3b82f6; color: white; }
        .btn-success { background: #22c55e; color: white; }
        .btn-danger { background: #ef4444; color: white; }
        .btn-warning { background: #f59e0b; color: white; }
        .btn-full { width: 100%; padding: 20px; font-size: 20px; }
        .task-box { background: white; padding: 20px; border-radius: 12px; border: 2px solid #86efac; margin-bottom: 16px; }
        .material-item { display: grid; grid-template-columns: 2fr 1fr 1fr 2fr auto; gap: 8px; margin-bottom: 12px; align-items: center; }
        .material-box { background: #f0fdf4; padding: 16px; border-radius: 8px; border: 1px solid #86efac; margin-top: 16px; }
        .equipment-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 12px; margin-bottom: 16px; }
        .equipment-btn { padding: 16px; background: white; border: 2px solid #d1d5db; border-radius: 8px; font-weight: 500; }
        .equipment-btn.active { background: #f97316; color: white; border-color: #f97316; }
        .report-item { background: #f9fafb; padding: 16px; border-radius: 8px; border: 1px solid #d1d5db; margin-bottom: 12px; display: flex; justify-content: space-between; align-items: center; }
        .hidden { display: none; }
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
        .flex-between { display: flex; justify-content: space-between; align-items: center; }
        .small-text { font-size: 12px; color: #6b7280; }
        @media (max-width: 768px) {
            .grid-2 { grid-template-columns: 1fr; }
            .material-item { grid-template-columns: 1fr; }
            h1 { font-size: 24px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div id="statusBar" class="status-bar">
            <div><span id="statusIcon">üì∂</span> <strong id="statusText">WiFi</strong></div>
            <div id="pendingReports"></div>
        </div>

        <div id="savedReportsList" class="card hidden"></div>

        <div class="card">
            <div class="header">
                <h1>üìã Rapport de Chantier</h1>
                <button class="btn-danger" onclick="resetForm()">üîÑ</button>
            </div>

            <div class="section section-blue">
                <h2>üë§ Informations g√©n√©rales</h2>
                <div class="grid-2">
                    <div>
                        <label>Date *</label>
                        <input type="date" id="date">
                    </div>
                    <div>
                        <label>Chef de chantier *</label>
                        <input type="text" id="chiefName" placeholder="Nom et pr√©nom">
                    </div>
                </div>
                <label>üìç Adresse du chantier *</label>
                <input type="text" id="siteAddress" placeholder="Adresse compl√®te">
                <div class="grid-2">
                    <div>
                        <label>‚òÅÔ∏è M√©t√©o</label>
                        <select id="weather">
                            <option>Ensoleill√©</option>
                            <option>Nuageux</option>
                            <option>Pluvieux</option>
                            <option>Orageux</option>
                            <option>Neigeux</option>
                            <option>Brouillard</option>
                        </select>
                    </div>
                </div>
            </div>

            <div class="section section-green">
                <div class="flex-between">
                    <h2>üì¶ T√¢ches et mat√©riaux</h2>
                    <button class="btn-success" onclick="addTask()">‚ûï Ajouter</button>
                </div>
                <div id="tasksList"></div>
            </div>

            <div class="section section-orange">
                <h2>üîß Mat√©riel en location</h2>
                <div class="equipment-grid" id="equipmentGrid"></div>
                <label>Autre mat√©riel (pr√©cisez)</label>
                <textarea id="otherEquipment" rows="3" placeholder="Autre mat√©riel en location..."></textarea>
            </div>

            <div class="section section-red">
                <h2>üìù Informations diverses et s√©curit√©</h2>
                <textarea id="safetyNotes" rows="6" placeholder="Remarques, incidents, consignes de s√©curit√©..."></textarea>
                <label>üì∑ Nombre de photos prises</label>
                <input type="number" id="photoCount" value="0" min="0">
                <p class="small-text" style="margin-top: 8px;">Note : Vous devrez joindre les photos manuellement √† l'email</p>
            </div>

            <div class="section section-purple">
                <h2>‚úçÔ∏è Signature et envoi</h2>
                <label>Signature (nom complet) *</label>
                <input type="text" id="signature" placeholder="Votre nom complet">
                <button class="btn-primary btn-full" style="margin-top: 24px; background: linear-gradient(135deg, #3b82f6 0%, #8b5cf6 100%);" onclick="saveReport()">
                    üíæ Sauvegarder le rapport (hors ligne)
                </button>
            </div>
        </div>
    </div>

    <script>
        const materials = ['Sable 0/4', 'Concass√© 0/4', 'Concass√© 0/20', 'Concass√© 0/31.5', 'Recycl√© 0/20', 'Recycl√© 0/25', 'Recycl√© 0/40', 'Terre V√©g√©tal', 'Tout Venant 0/63', 'B√©ton 150', 'B√©ton 250', 'B√©ton 350', 'Enrob√©s 0/8', 'Enrob√©s 0/11', 'D√©blais'];
        const origins = ['DEPOT - Ch√¢tenois', 'LEONHART ‚Äì S√©lestat', 'VVK ‚Äì Ebersheim', 'NEXSTONE ‚Äì Bischoffsheim', 'NEXTSONE ‚Äì Schirmeck', 'LRT ‚Äì Turckheim', 'ALTER ‚Äì Bennwihr', 'JEHL ‚Äì Artolsheim', 'ELBEN ‚Äì Niederhergheim', 'EST ENROBES ‚Äì S√©lestat', 'NOUVELLE CARRIERE ALSACE - Metzeral'];
        const equipment = ['√âchafaudage', 'B√©tonni√®re', 'Pelleteuse', 'Mini-pelle', 'Compacteur', 'Marteau-piqueur', 'Nacelle √©l√©vatrice', 'Grue', 'Camion benne', 'Compresseur', 'Groupe √©lectrog√®ne', 'Scie √† b√©ton', 'Meuleuse', 'Pompe √† eau', 'Autre'];
        
        let tasks = [{materials: [{}]}];
        let selectedEquipment = [];
        let isOnline = navigator.onLine;

        function init() {
            document.getElementById('date').value = new Date().toISOString().split('T')[0];
            renderEquipmentGrid();
            renderTasks();
            updateStatus();
            loadSavedReports();
            window.addEventListener('online', () => { isOnline = true; updateStatus(); });
            window.addEventListener('offline', () => { isOnline = false; updateStatus(); });
        }

        function updateStatus() {
            const bar = document.getElementById('statusBar');
            const icon = document.getElementById('statusIcon');
            const text = document.getElementById('statusText');
            if (isOnline) {
                bar.className = 'status-bar';
                icon.textContent = 'üì∂';
                text.textContent = '‚úÖ WiFi';
            } else {
                bar.className = 'status-bar offline';
                icon.textContent = 'üìµ';
                text.textContent = 'üìµ Hors ligne';
            }
            const saved = JSON.parse(localStorage.getItem('savedReports') || '[]');
            document.getElementById('pendingReports').innerHTML = saved.length > 0 
                ? `<span style="font-weight:600">${saved.length} en attente</span> <button class="btn-primary" style="padding:4px 12px;margin-left:8px" onclick="toggleSavedReports()">${document.getElementById('savedReportsList').classList.contains('hidden') ? 'Voir' : 'Masquer'}</button>`
                : '';
        }

        function renderEquipmentGrid() {
            const grid = document.getElementById('equipmentGrid');
            grid.innerHTML = equipment.map(eq => 
                `<button class="equipment-btn" onclick="toggleEquipment('${eq}')" id="eq_${eq.replace(/\s/g,'_')}">${eq}</button>`
            ).join('');
        }

        function toggleEquipment(eq) {
            const idx = selectedEquipment.indexOf(eq);
            if (idx > -1) {
                selectedEquipment.splice(idx, 1);
            } else {
                selectedEquipment.push(eq);
            }
            document.getElementById('eq_' + eq.replace(/\s/g,'_')).classList.toggle('active');
        }

        function renderTasks() {
            const list = document.getElementById('tasksList');
            list.innerHTML = tasks.map((task, i) => `
                <div class="task-box">
                    <div class="flex-between" style="margin-bottom:12px">
                        <strong style="color:#16a34a;font-size:18px">T√¢che ${i+1}</strong>
                        ${tasks.length > 1 ? `<button class="btn-danger" onclick="removeTask(${i})">üóëÔ∏è</button>` : ''}
                    </div>
                    <textarea rows="2" placeholder="Description de la t√¢che" onchange="updateTask(${i}, 'description', this.value)">${task.description||''}</textarea>
                    <div class="material-box">
                        <div class="flex-between" style="margin-bottom:12px">
                            <strong style="color:#15803d">Mat√©riaux utilis√©s</strong>
                            <button class="btn-success" style="padding:6px 12px;font-size:14px" onclick="addMaterial(${i})">‚ûï</button>
                        </div>
                        ${(task.materials || [{}]).map((mat, mi) => `
                            <div class="material-item">
                                <select onchange="updateMaterial(${i}, ${mi}, 'type', this.value)">
                                    <option value="">Mat√©riau</option>
                                    ${materials.map(m => `<option ${mat.type===m?'selected':''}>${m}</option>`).join('')}
                                </select>
                                <input type="number" step="0.01" placeholder="Qt√©" value="${mat.quantity||''}" onchange="updateMaterial(${i}, ${mi}, 'quantity', this.value)">
                                <select onchange="updateMaterial(${i}, ${mi}, 'unit', this.value)">
                                    <option ${mat.unit==='ml'?'selected':''}>ml</option>
                                    <option ${mat.unit==='m3'||!mat.unit?'selected':''}>m¬≥</option>
                                    <option ${mat.unit==='m2'?'selected':''}>m¬≤</option>
                                    <option ${mat.unit==='unit√©'?'selected':''}>unit√©</option>
                                </select>
                                <select onchange="updateMaterial(${i}, ${mi}, 'origin', this.value)">
                                    <option value="">Provenance</option>
                                    ${origins.map(o => `<option ${mat.origin===o?'selected':''}>${o}</option>`).join('')}
                                </select>
                                ${task.materials.length > 1 ? `<button class="btn-danger" onclick="removeMaterial(${i}, ${mi})">üóëÔ∏è</button>` : ''}
                            </div>
                        `).join('')}
                    </div>
                </div>
            `).join('');
        }

        function addTask() { tasks.push({materials: [{}]}); renderTasks(); }
        function removeTask(i) { tasks.splice(i, 1); renderTasks(); }
        function updateTask(i, field, value) { tasks[i][field] = value; }
        function addMaterial(taskIdx) { tasks[taskIdx].materials.push({}); renderTasks(); }
        function removeMaterial(taskIdx, matIdx) { tasks[taskIdx].materials.splice(matIdx, 1); renderTasks(); }
        function updateMaterial(taskIdx, matIdx, field, value) { tasks[taskIdx].materials[matIdx][field] = value; }

        function resetForm() {
            if (confirm('R√©initialiser tout le formulaire ?')) {
                document.getElementById('date').value = new Date().toISOString().split('T')[0];
                document.getElementById('chiefName').value = '';
                document.getElementById('siteAddress').value = '';
                document.getElementById('weather').value = 'Ensoleill√©';
                document.getElementById('otherEquipment').value = '';
                document.getElementById('safetyNotes').value = '';
                document.getElementById('photoCount').value = '0';
                document.getElementById('signature').value = '';
                tasks = [{materials: [{}]}];
                selectedEquipment = [];
                renderTasks();
                renderEquipmentGrid();
            }
        }

        function generateEmailBody(data) {
            let body = 'RAPPORT DE CHANTIER JOURNALIER\n\n';
            body += `Date: ${data.date}\nChef: ${data.chiefName}\nAdresse: ${data.siteAddress}\nM√©t√©o: ${data.weather}\n\n`;
            body += 'T√ÇCHES:\n' + '='.repeat(60) + '\n\n';
            data.tasks.forEach((task, i) => {
                if (task.description) {
                    body += `${i+1}. ${task.description}\n`;
                    if (task.materials) {
                        body += '   Mat√©riaux:\n';
                        task.materials.forEach(mat => {
                            if (mat.type) {
                                body += `   - ${mat.type}`;
                                if (mat.quantity) body += `: ${mat.quantity} ${mat.unit||''}`;
                                if (mat.origin) body += ` (${mat.origin})`;
                                body += '\n';
                            }
                        });
                    }
                    body += '\n';
                }
            });
            if (data.equipment.length > 0 || data.otherEquipment) {
                body += '\nMAT√âRIEL EN LOCATION:\n' + '='.repeat(60) + '\n';
                data.equipment.forEach(eq => body += `‚Ä¢ ${eq}\n`);
                if (data.otherEquipment) body += `‚Ä¢ Autre: ${data.otherEquipment}\n`;
                body += '\n';
            }
            if (data.safetyNotes) body += `\nINFORMATIONS ET S√âCURIT√â:\n${'='.repeat(60)}\n${data.safetyNotes}\n\n`;
            if (data.photoCount > 0) body += `\nüì∑ PHOTOS: ${data.photoCount} photo(s) √† joindre\n\n`;
            if (data.signature) body += `\nSignature: ${data.signature}\n`;
            return body;
        }

        function saveReport() {
            const data = {
                date: document.getElementById('date').value,
                chiefName: document.getElementById('chiefName').value,
                siteAddress: document.getElementById('siteAddress').value,
                weather: document.getElementById('weather').value,
                tasks: tasks,
                equipment: selectedEquipment,
                otherEquipment: document.getElementById('otherEquipment').value,
                safetyNotes: document.getElementById('safetyNotes').value,
                photoCount: document.getElementById('photoCount').value,
                signature: document.getElementById('signature').value,
                savedAt: new Date().toISOString(),
                id: Date.now()
            };
            if (!data.chiefName || !data.siteAddress || !data.signature) {
                alert('‚ö†Ô∏è Remplissez les champs obligatoires (Chef, Adresse, Signature)');
                return;
            }
            const saved = JSON.parse(localStorage.getItem('savedReports') || '[]');
            saved.push(data);
            localStorage.setItem('savedReports', JSON.stringify(saved));
            alert('‚úÖ Rapport sauvegard√© !\n\nDisponible pour envoi avec WiFi.');
            resetForm();
            updateStatus();
            loadSavedReports();
        }

        function loadSavedReports() {
            const saved = JSON.parse(localStorage.getItem('savedReports') || '[]');
            const list = document.getElementById('savedReportsList');
            if (saved.length === 0) {
                list.classList.add('hidden');
                return;
            }
            list.innerHTML = `
                <div class="flex-between" style="margin-bottom:16px">
                    <h2>Rapports en attente</h2>
                    ${isOnline ? `<button class="btn-success" onclick="syncAll()">‚¨ÜÔ∏è Tout synchroniser</button>` : ''}
                </div>
                ${saved.map(r => `
                    <div class="report-item">
                        <div>
                            <strong>${r.chiefName} - ${r.date}</strong><br>
                            <span style="font-size:14px;color:#6b7280">${r.siteAddress}</span><br>
                            <span style="font-size:12px;color:#9ca3af">Sauvegard√©: ${new Date(r.savedAt).toLocaleString('fr-FR')}</span>
                        </div>
                        <div>
                            ${isOnline ? `<button class="btn-primary" onclick="sendReport(${r.id})">üìß</button>` : ''}
                            <button class="btn-danger" onclick="deleteReport(${r.id})">üóëÔ∏è</button>
                        </div>
                    </div>
                `).join('')}
            `;
        }

        function toggleSavedReports() {
            document.getElementById('savedReportsList').classList.toggle('hidden');
            updateStatus();
        }

        function sendReport(id) {
            const saved = JSON.parse(localStorage.getItem('savedReports') || '[]');
            const report = saved.find(r => r.id === id);
            if (!report) return;
            const subject = encodeURIComponent(`Rapport chantier - ${report.chiefName} - ${report.date}`);
            const body = encodeURIComponent(generateEmailBody(report));
            window.location.href = `mailto:feldner.guillaume@feldner-reseaux.fr?subject=${subject}&body=${body}`;
        }

        function deleteReport(id) {
            if (confirm('Supprimer ce rapport ?')) {
                const saved = JSON.parse(localStorage.getItem('savedReports') || '[]');
                localStorage.setItem('savedReports', JSON.stringify(saved.filter(r => r.id !== id)));
                loadSavedReports();
                updateStatus();
            }
        }

        function syncAll() {
            if (!isOnline) {
                alert('‚ùå Pas de connexion Internet');
                return;
            }
            const saved = JSON.parse(localStorage.getItem('savedReports') || '[]');
            if (saved.length === 0) {
                alert('Aucun rapport en attente');
                return;
            }
            if (confirm(`Envoyer ${saved.length} rapport(s) ?`)) {
                saved.forEach((r, i) => setTimeout(() => sendReport(r.id), i * 1000));
                setTimeout(() => {
                    if (confirm('Supprimer les rapports synchronis√©s ?')) {
                        localStorage.removeItem('savedReports');
                        loadSavedReports();
                        updateStatus();
                    }
                }, saved.length * 1000 + 500);
            }
        }

        init();
    </script>
</body>
</html>
